<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Tunebook | Baton Rouge Fiddle Jam</title>
    <!-- <meta name="description" content="The HTML5 Herald">
  <meta name="author" content="SitePoint"> -->

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="css/abcjs-midi.css">
    <!-- <link rel="stylesheet" href="css/style.css"> -->

    <link rel="stylesheet" type="text/css" href="css/taggle.css">

    <style>

    </style>
</head>

<body class="bg-dark" style="background-color: #333;">

    <section class="">
        <!-- container -->
        <div class="container-fluid">
            <div class="row">
                <div class="col-3">
                        <div class="input textarea clearfix search" style="margin: 50px;"></div>
                </div>
                <div class="col-9">test </div>
            </div>
        </div>
        <p></p>
        <p></p>
        <p></p>
        <p></p>
        <p></p>
    </section>
    <!-- menu -->
    <!-- body -->


    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/abcjs_midi_5.10.2-min.js" type="text/javascript"></script>
    <script src="js/taggle.min.js" type="text/javascript"></script>
    <script src="js/tunes.js"></script>

    <script>

        let getTitleHtml = (tune) => `
            <div class="row">
                <div class="col">
                    <h2 id="title">${tune.title}</h2>
                </div>
            </div>`;

        let getMidiHtml = (tune) => `
            <div class="card mb-2" id="card-midi">
                <h5 class="card-header">Midi</h5>
                <div class="card-body" id="midi">
                </div>
            </div>`;

        let getNotationHtml = (tune) => `
            <div class="card mb-2" id="card-notation">
                <h5 class="card-header">Notation</h5>
                <div class="card-body" id="notation">
                </div>
            </div>`;

        let getTagsHtml = (tune) => {
            if (tune.tags == null || typeof (tune.tags) != "object") return '';

            let tagsHtml = '';
            tune.tags.forEach(tag => tagsHtml += `<span class="badge badge-secondary">${tag.toLowerCase()}</span> `);

            return `
            <div class="card mb-2" id="card-tags">
                <h5 class="card-header">Tags</h5>
                <div class="card-body">
                    ${tagsHtml}
                </div>
            </div>`;
        };

        let getNotesHtml = (tune) => (tune.notes != null) ? `
            <div class="card mb-2" id="card-notes">
                <h5 class="card-header">Notes</h5>
                <div class="card-body">
                    <p>${tune.notes}</p>
                </div>
            </div>` : '';

        let getResourcesHtml = (tune) => `
            <div class="card mb-2" id="card-resources">
                <h5 class="card-header">Resources</h5>
                <div class="card-body">
                </div>
            </div>`;

        function displayTune(index) {
            let tune = tunes[index];
            if (tune == null || currentIndex == index) return;

            currentIndex = index;
            ABCJS.midi.stopPlaying();

            document.getElementById("default").classList.add("d-none");
            let tuneContainer = document.getElementById("tune")

            tuneContainer.classList.remove("d-none");
            tuneContainer.innerHTML = '';

            let tuneHtml = `
                ${getTitleHtml(tune)}
                <div class="row">
                    <div class="col-lg-9 col-12 px-1">
                        ${getMidiHtml(tune)}
                        ${getNotationHtml(tune)}
                    </div>
                    <div class="col-lg-3 col-12 px-1">
                        ${getTagsHtml(tune)}
                        ${getNotesHtml(tune)}
                        ${getResourcesHtml(tune)}
                    </div>
                </div>`;

            tuneContainer.innerHTML = tuneHtml;

            const renderedTune = ABCJS.renderAbc(
                "notation",
                tune.abc,
                {
                    add_classes: true,
                    responsive: "resize",
                });

            ABCJS.renderMidi("midi", tune.abc,
                {
                    // program: 41,
                    animate: {
                        listener: noteHighlight.animationCallback.bind(noteHighlight),
                        target: renderedTune[0],
                        qpm: 120
                    },
                    inlineControls: {
                        loopToggle: true,
                    }
                });

        }

        // convert this to a class method somehow 
        function getHeading(tune) {
            return tune
                .title
                .charAt(0)
                .toUpperCase();
        }

        function updateTunelist(tunes) {
            let showHeadings = (tunes.length > 2) ? true : false;
            let tunelistHtml = '';

            let prevHeading = "";
            tunes.forEach(tune => {
                if (showHeadings) {
                    let currHeading = getHeading(tune);
                    if (currHeading != prevHeading) {
                        tunelistHtml += `<p>${currHeading}</p>`;
                        prevHeading = currHeading;
                    }
                }
                tunelistHtml += `<li class="nav-item"><a class="nav-link" href="javascript://" data-index="${tune.index}" onclick="displayTune(${tune.index})">${tune.title}</a></li>`;
            });

            let tunelistContainer = document.getElementById("tunelist");
            tunelistContainer.innerHTML = tunelistHtml;
        }

        var noteHighlight = {
            colorRange(range, color) {
                if (range && range.elements) {
                    range.elements.forEach(function (set) {
                        set.forEach(function (item) {
                            item.setAttribute("fill", color);
                        });
                    });
                }
            },
            animationCallback(lastRange, currentRange, context) {
                this.colorRange(lastRange, "#000000");
                this.colorRange(currentRange, "#3D9AFC");
            }
        };

        // let currentIndex = -1;

        // const fieldsToReplace = [
        //     { field: "title", regex: /\nT: *(.*)(?=\n)/ },
        //     { field: "notes", regex: /\nN: *(.*)(?=\n)/ }
        // ];

        // tunes.forEach(tune => {
        //     tune.abc = tune.abc
        //         .replace(/(?<=\n) +/g, '')
        //         .trim()
        //     fieldsToReplace.forEach(ftr => {
        //         if (ftr.regex.test(tune.abc)) {
        //             tune[ftr.field] = tune.abc.match(ftr.regex)[1];
        //             tune.abc = tune.abc.replace(ftr.regex, '');
        //         }
        //     });
        // });

        // tunes = tunes
        //     .filter(tune => tune.title != null)
        //     .sort((a, b) => {
        //         if (a.title.toUpperCase() < b.title.toUpperCase())
        //             return -1;
        //         else if (a.title.toUpperCase() > b.title.toUpperCase())
        //             return 1;
        //         else
        //             return 0;
        //     });

        // // add indexes
        // let index = 0;
        // tunes.forEach(tune => {
        //     tune.index = index;
        //     index++;
        // })

        // // update tunelist 
        // updateTunelist(tunes);




        $(document).ready(function () {

            new Taggle($('.example1')[0], {
                placeholder: "Search..."
            });

            // $('#navToggle').on('click', function () {
            //     $('.offcanvas-nav').toggleClass('open')
            // });

            // $('#main').on('click', function () {
            //     $('.offcanvas-collapse').removeClass('open')
            // });

        });


    </script>

</body>

</html>