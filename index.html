<!doctype html>

<html lang="en">

<head>
   	<meta charset="utf-8">

    <title>Tunebook | Baton Rouge Fiddle Jam</title>
    <!-- <meta name="description" content="The HTML5 Herald">
  <meta name="author" content="SitePoint"> -->

    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css"> -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
        integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous"> -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="css/abcjs-midi.css">
    <link rel="stylesheet" href="css/style.css">

</head>

<body>

    <section class="bg-primary">
        <div class="container">

            <!--  START NAVBAR   -->
            <nav class="navbar navbar-expand-lg fixed-top navbar-dark bg-dark navbar-offcanvas">

                <!--      This toggle button is always visible  -->
                <button class="navbar-toggler d-block" type="button" id="navToggle">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <span class="navbar-brand mr-auto pl-2 h1 mb-0">Tunebook | Baton Rouge Fiddle Jam</span>

                <!--     If you want to show the button online on mobile use this toggle   
                
                <button class="navbar-toggler p-0 border-0" type="button" data-toggle="offcanvas">
                    <span class="navbar-toggler-icon"></span>
                </button>
            
            -->


                <div class="navbar-collapse offcanvas-collapse">

                    <ul class="navbar-nav mr-auto">
                        <div class="mb-2 mt-2">
                            <div>
                                <form class="form-inline">
                                    <input class="form-control" type="search" placeholder="Search" aria-label="Search">
                                </form>
                            </div>
                        </div>

                        <div id="tunelist">
                            <!-- <p>Heading</p>
                            <li class="nav-item active">
                                <a class="nav-link" href="#">Dashboard <span class="sr-only">(current)</span></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">Notifications</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">Profile</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">Switch account</a>
                            </li> -->
                        </div>
                        <!-- <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://example.com" id="dropdown01"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Settings</a>
                            <div class="dropdown-menu" aria-labelledby="dropdown01">
                                <a class="dropdown-item" href="#">Action</a>
                                <a class="dropdown-item" href="#">Another action</a>
                                <a class="dropdown-item" href="#">Something else here</a>
                            </div>
                        </li> -->
                    </ul>


                </div>
            </nav>
            <!--  END NAVBAR   -->

        </div>
        <!--/.container    -->

    </section>


    <section id="main">
        <div class="container py-3 d-none" id="default">
            <span>Select a tune from the menu.</span>
        </div>

        <div class="container-fluid py-3" id="tune">

            <div class="row">
                <div class="col">
                    <h2 id="title">Tune title</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-9 col-12 px-1">

                    <div class="card mb-2" id="midi">
                        <h5 class="card-header">Midi</h5>
                        <div class="card-body">
                        </div>
                    </div>

                    <div class="card mb-2" id="notation">
                        <h5 class="card-header">Notation</h5>
                        <div class="card-body">
                        </div>
                    </div>

                </div>

                <div class="col-lg-3 col-12 px-1">

                    <div class="card mb-2" id="tags">
                        <h5 class="card-header">Tags</h5>
                        <div class="card-body">
                            <span class="badge badge-secondary">Tag 1</span>
                            <span class="badge badge-secondary">Tag 2</span>
                            <span class="badge badge-secondary">Tag 3</span>
                        </div>
                    </div>

                    <div class="card mb-2" id="notes">
                        <h5 class="card-header">Notes</h5>
                        <div class="card-body">
                        </div>
                    </div>

                    <div class="card mb-2" id="resources">
                        <h5 class="card-header">Resources</h5>
                        <div class="card-body">
                        </div>
                    </div>

                </div>

            </div>


        </div>

    </section>



    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- <script src="js/DynamicTableClass-2.3.js"></script> -->
	<script src="js/abcjs_midi_5.10.2-min.js" type="text/javascript"></script>
    <script src="js/tunes.js"></script>


    <!-- <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script> -->
    <!-- <script src="https://cdn.rawgit.com/JacobLett/bootstrap4-latest/504729ba/bootstrap-4-latest.min.js"></script> -->
    <script>

        let getTitleHtml = (tune) => `
            <div class="row">
                <div class="col">
                    <h2 id="title">${tune.title}</h2>
                </div>
            </div>`;

        let getMidiHtml = (tune) => `
            <div class="card mb-2" id="card-midi">
                <h5 class="card-header">Midi</h5>
                <div class="card-body" id="midi">
                </div>
            </div>`;

        let getNotationHtml = (tune) => `
            <div class="card mb-2" id="card-notation">
                <h5 class="card-header">Notation</h5>
                <div class="card-body" id="notation">
                </div>
            </div>`;

        let getTagsHtml = (tune) => {
            if (tune.tags == null || typeof(tune.tags) != "object") return '';

            let tagsHtml = '';
            tune.tags.forEach(tag => tagsHtml += `<span class="badge badge-secondary">${tag.toLowerCase()}</span> `);

            return `
            <div class="card mb-2" id="card-tags">
                <h5 class="card-header">Tags</h5>
                <div class="card-body">
                    ${tagsHtml}
                </div>
            </div>`;
        };

        let getNotesHtml = (tune) => (tune.notes != null) ? `
            <div class="card mb-2" id="card-notes">
                <h5 class="card-header">Notes</h5>
                <div class="card-body">
                    <p>${tune.notes}</p>
                </div>
            </div>` : '';

        let getResourcesHtml = (tune) => `
            <div class="card mb-2" id="card-resources">
                <h5 class="card-header">Resources</h5>
                <div class="card-body">
                </div>
            </div>`;

        function displayTune(index) {
            let tune = tunes[index];
            if (tune == null || currentIndex == index) return;

            currentIndex = index;
            ABCJS.midi.stopPlaying();

            document.getElementById("default").classList.add("d-none");
            let tuneContainer = document.getElementById("tune")

            tuneContainer.classList.remove("d-none");
            tuneContainer.innerHTML = '';

            let tuneHtml = `
                ${getTitleHtml(tune)}
                <div class="row">
                    <div class="col-lg-9 col-12 px-1">
                        ${getMidiHtml(tune)}
                        ${getNotationHtml(tune)}
                    </div>
                    <div class="col-lg-3 col-12 px-1">
                        ${getTagsHtml(tune)}
                        ${getNotesHtml(tune)}
                        ${getResourcesHtml(tune)}
                    </div>
                </div>`;

            tuneContainer.innerHTML = tuneHtml;

            const renderedTune = ABCJS.renderAbc(
				"notation",
				tune.abc,
				{
					add_classes: true,
					responsive: "resize",
				});

            ABCJS.renderMidi("midi", tune.abc,
				{
					// program: 41,
					animate: { 
						listener: noteHighlight.animationCallback.bind(noteHighlight),
						target: renderedTune[0], 
						qpm: 120 },
					inlineControls: {
						loopToggle: true,
					}
				});

        }

        // convert this to a class method somehow 
        function getHeading(tune) {
            return tune
                .title
                .charAt(0)
                .toUpperCase();
        }

        function updateTunelist(tunes) {
            let showHeadings = (tunes.length > 2) ? true : false;
            let tunelistHtml = '';

            let prevHeading = "";
            tunes.forEach(tune => {
                if (showHeadings) {
                    let currHeading = getHeading(tune);
                    if (currHeading != prevHeading) {
                        tunelistHtml += `<p>${currHeading}</p>`;
                        prevHeading = currHeading;
                    }
                }
                tunelistHtml += `<li class="nav-item"><a class="nav-link" href="javascript://" data-index="${tune.index}" onclick="displayTune(${tune.index})">${tune.title}</a></li>`;
            });

            let tunelistContainer = document.getElementById("tunelist");
            tunelistContainer.innerHTML = tunelistHtml;
        }

        var noteHighlight = {
			colorRange(range, color) {
				if (range && range.elements) {
					range.elements.forEach(function (set) {
						set.forEach(function (item) {
							item.setAttribute("fill",color);
						});
					});
				}
			},
			animationCallback(lastRange, currentRange, context) {
				this.colorRange(lastRange, "#000000");
				this.colorRange(currentRange, "#3D9AFC");
			}
        };
        
        let currentIndex = -1;

        const fieldsToReplace = [
            { field: "title", regex: /\nT: *(.*)(?=\n)/ },
            { field: "notes", regex: /\nN: *(.*)(?=\n)/ }
        ];

        tunes.forEach(tune => {
            tune.abc = tune.abc
                .replace(/(?<=\n) +/g, '')
                .trim()
            fieldsToReplace.forEach(ftr => {
                if (ftr.regex.test(tune.abc)) {
                    tune[ftr.field] = tune.abc.match(ftr.regex)[1];
                    tune.abc = tune.abc.replace(ftr.regex, '');
                }
            });
        });

        tunes = tunes
            .filter(tune => tune.title != null)
            .sort((a, b) => {
                if (a.title.toUpperCase() < b.title.toUpperCase())
                    return -1;
                else if (a.title.toUpperCase() > b.title.toUpperCase())
                    return 1;
                else
                    return 0;
            });

        // add indexes
        let index = 0;
        tunes.forEach(tune => {
            tune.index = index;
            index++;
        })


        // update tunelist 
        updateTunelist(tunes);




        $(document).ready(function () {

            $('[data-toggle="offcanvas"], #navToggle').on('click', function () {
                $('.offcanvas-collapse').toggleClass('open')
            });

            $('#main').on('click', function() {
                $('.offcanvas-collapse').removeClass('open')
            });

        });


    </script>

</body>

</html>